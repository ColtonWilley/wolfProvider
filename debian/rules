#!/usr/bin/make -f

%:
	dh $@ --with autoreconf

# Multiarch triplet
DEB_HOST_MULTIARCH := $(shell dpkg-architecture -qDEB_HOST_MULTIARCH)
# Destination directory for installation
DESTDIR=debian/tmp

# Grab the base version from debian/changelog
BASEVER := $(shell dpkg-parsechangelog -SVersion)

# Check if FIPS build is requested
WOLFSSL_ISFIPS?=0
# Variant-specific metadata
ifeq ($(WOLFSSL_ISFIPS),1)
  VARIANT           := fips
  VARIANT_DESC      := FIPS build
  VARIANT_PROVIDES  := libwolfprov-fips
  VERSION           := $(BASEVER)+fips
  FIPS_FLAG         := --enable-fips
  PROVIDER_CONF     := provider-fips.conf
else
  VARIANT           := non-fips
  VARIANT_DESC      := non-FIPS build
  VARIANT_PROVIDES  := libwolfprov-nonfips
  VERSION           := $(BASEVER)
  PROVIDER_CONF     := provider.conf
  FIPS_FLAG         :=
endif

# Override just the control-file generation to inject our values
override_dh_gencontrol:
	dh_gencontrol -- \
	 -v$(VERSION) \
	 -Vvariant=$(VARIANT) \
	 -Vvariant:desc="$(VARIANT_DESC)" \
	 -Vvariant:provides="$(VARIANT_PROVIDES)"

override_dh_auto_configure:
	# None, handled below

override_dh_auto_build:
	./scripts/build-wolfprovider.sh $(FIPS_FLAG)

override_dh_auto_install:
	# Install library
	install -d $(DESTDIR)/usr/lib/$(DEB_HOST_MULTIARCH)/ossl-modules
	install -m755 ./.libs/libwolfprov.so* \
		$(DESTDIR)/usr/lib/$(DEB_HOST_MULTIARCH)/ossl-modules/

	# Install headers
	install -d $(DESTDIR)/usr/include/wolfprovider
	install -m644 ./include/wolfprovider/*.h \
		$(DESTDIR)/usr/include/wolfprovider/

	# Install provider config file
	install -d $(DESTDIR)/etc/ssl/openssl.cnf.d
	install -m644 ./$(PROVIDER_CONF) \
		$(DESTDIR)/etc/ssl/openssl.cnf.d/wolfprovider.conf

override_dh_auto_clean:
	dh_auto_clean
	./scripts/build-wolfprovider.sh --clean --distclean

override_dh_auto_test:
	@echo "Skipping dh_auto_test (tests already run during build phase)"

# Avoid warnings of the form package-has-unnecessary-activation-of-ldconfig-trigger
override_dh_makeshlibs:
	dh_makeshlibs -n

